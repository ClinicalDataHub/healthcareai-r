---
title: "Database Connections using healthcare.ai"
author: "Mike Mastanduno"
date: "4/1/2018"
output: html_document
---

**Database connections**

Let's be honest. You need to get data from a database, do some really awesome 
stuff with `R`, and then write the results back to a database. `R` can help
with that. There are lots of different databases, but this document will focus
on Microsoft SQL Server. R supports most databases, and 
I'd encourage you to look at their [help pages](https://db.rstudio.com/) 
for additional resources. Andiamo!

If you simply want a code snippet to copy and paste, scroll to the bottom.

# Reading data

#### Connecting to a Database

Before you can do anything, you must make a connection to your database. The 
`build_connection_string` function takes care of the syntax for you and returns
a connection string that's ready to be passed into `DBI::dbConnect`. After
you have a valid connection, you should be able to browse the database using 
RStudio's Connections pane. If you don't have a connections pane, upgrade your 
Rstudio. It's worth it.

```{r, eval=FALSE}
library(healthcareai)
library(DBI)

my_con <- build_connection_string(server = "HCS-GM0004",
                                  database = "SAM")
con <- DBI::dbConnect(odbc::odbc(), .connection_string = my_con)
```


#### Using SQL Code

From here, you can read data from the database in a couple different ways. You
can use `db_read` to execute SQL code, or you can use `dbplyr` functionaliity
to execute `dplyr` code directly against the database.
```{r, eval=FALSE}
query <- "SELECT
          ,COUNT(*),
          ,year(AdmitDT) as AdmitYear
          FROM [SAM].[Encounter].[PatientEncounterBASE]
          WHERE AdmitYear >= 2013
          GROUP BY AdmitYear
          ORDER BY AdmitYear"

d <- db_read(con, query)
```
This query counts admits by year. If you don't want to pull the results into
memory, as might the be the case with large tables, set the `pull_into_memory`
flag to FALSE. This will create a pointer to the database that can be 
executed "lazily". In other words R will wait until the last moment to execute 
the statement.

#### Using dplyr Code

The other option is to use dplyr code. Set up a reference to the table, then use
it to pull data. The last line, `collect()`, is what actually pulls the data 
into memory.
```{r, eval=FALSE}
library(tidyverse)

encounter <- tbl(con, in_schema("Encounter", "PatientEncounterBASE"))

d <- encounter %>%
  mutate(AdmitYear = year(AdmitDT)) %>%
  filter(AdmitYear >= 2013) %>%
  group_by(AdmitYear) %>%
  tally() %>%
  collect()
```

# Writing Data
As of 4/1/2018, there are two ways to write to a database: 

1. The latest version of `odbc`, which is the back end to `DBI`, 
installed from Github. The CRAN version does not support database schemas.
2. `RODBC`

In either case, the data you are trying to write must match the destination
table's column names and data types.

#### Writing with DBI

DBI requires that you set up the table as an object before trying to write to
it. Assuming there was a table called `SAM.Sepsis.Predictions` with columns
patient_id (int) and predicted_probability (float).
```{r, eval=FALSE}
devtools::install_github("r-dbi/odbc")

predictions <- data.frame(patient_id = c(1,2,3),
                          predicted_probability = c(0.7, 0.2, 0.4))

table_id <- DBI::Id(name = "Predictions", 
                    schema = "Sepsis", 
                    catalog = "SAM")

res <- DBI::dbWriteTable(conn = my_con,
                         name = table_id,
                         value = predictions,
                         append = TRUE)

dbDisconnect(con)
```

####Writing with RODBC

RODBC is not the preferred way to interact with a database becuase it doesn't
work with RStudio's connections pane. However, the package is available on CRAN
and does support schemas. To use it, you must set up an RODBC connection to the 
database, as a DBI connection won't work.
```{r, eval=FALSE}
library(RODBC)
# Make a connection
my_con <- build_connection_string(server = "HCS-GM0004",
                                  database = "SAM")
con <- odbcDriverConnect(connection = con)

# Write data 
predictions <- data.frame(patient_id = c(1,2,3),
                          predicted_probability = c(0.7, 0.2, 0.4))

sqlSave(con, 
        predictions, 
        "Sepsis.Predictions", 
        append = TRUE, 
        rownames = FALSE)

odbcClose(con)
```




# Example Code Snippet
Copy-Pasta

