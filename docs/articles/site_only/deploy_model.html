<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Deploying a model • healthcareai</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.7/yeti/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js" integrity="sha384-cV+rhyOuRHc9Ub/91rihWcGmMmCXDeksTtCihMupQHSsi8GIIRDG0ThDc3HGQFJ3" crossorigin="anonymous"></script><!-- pkgdown --><link href="../../pkgdown.css" rel="stylesheet">
<script src="../../jquery.sticky-kit.min.js"></script><script src="../../pkgdown.js"></script><meta property="og:title" content="Deploying a model">
<meta property="og:description" content="">
<meta property="og:image" content="https://docs.healthcare.ai/logo.png">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Google analytics --><script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-85609357-1', 'auto');
  ga('send', 'pageview');

</script><!-- docsearch --><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css">
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../../index.html">healthcareai</a>
        <span class="label label-default" data-toggle="tooltip" data-placement="bottom" title="Released package">2.0.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Vignettes
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../../articles/site_only/healthcareai.html">Getting Started</a>
    </li>
    <li>
      <a href="../../articles/site_only/db_connections.html">Database Connections</a>
    </li>
    <li>
      <a href="../../articles/site_only/deploy_model.html">Deploying a model</a>
    </li>
    <li>
      <a href="../../articles/site_only/transitioning.html">Transition from Version 1</a>
    </li>
  </ul>
</li>
<li>
  <a href="../../reference/index.html">Functions</a>
</li>
<li>
  <a href="../../news/index.html">News</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/HealthCatalyst/healthcareai-r">
    <span class="fa fa-github"></span>
     
  </a>
</li>
<li>
  <a href="https://healthcare-ai.slack.com/">
    <span class="fa fa-users"></span>
     
  </a>
</li>
      </ul>
<form class="navbar-form navbar-right" role="search">
        <div class="form-group">
          <input type="search" class="form-control" id="search-input" placeholder="Search..." aria-label="Search for..." autocomplete="off">
</div>
      </form>
      
    </div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Deploying a model</h1>
            
      
      

    </div>

    
    
<p>Now that you’ve put in the work of building a model and it’s performing well on historical data, congratulations! It’s now time to prepare it to make reoccurring predictions. <strong>This document focuses on the requirements needed <em>before</em> you actually talk to the DBA/ETL team about creating the reoccurring schedule.</strong> At this point, you have</p>
<ul>
<li>Chosen a use case and an outcome to predict</li>
<li>Gathered your feature (i.e., input variable) list to make predictions</li>
<li>Trained a model that meets your performance requirements</li>
</ul>
<p>If you’ve done those, push on below!</p>
<div id="creating-and-saving-a-model" class="section level1">
<h1 class="hasAnchor">
<a href="#creating-and-saving-a-model" class="anchor"></a>Creating and saving a model</h1>
<p>In order to work with models in a production environment, first you must be able to have a saved model on disk. While we keep this section minimal, you can find out more about model training in our <a href="https://docs.healthcare.ai/articles/site_only/healthcareai.html">Getting Started vignette</a>. If curious, you can find more about database connections <a href="https://docs.healthcare.ai/articles/site_only/db_connections.html">here</a></p>
<p><em>Note, install tidyverse via</em> <code>install.packages('tidyverse')</code></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(healthcareai)
<span class="kw">library</span>(DBI)
<span class="kw">library</span>(tidyverse)

my_con &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/build_connection_string.html">build_connection_string</a></span>(<span class="dt">server =</span> <span class="st">"HCS-GM0004"</span>,
                                  <span class="dt">database =</span> <span class="st">"SAM"</span>)

con &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/DBI/topics/dbConnect">dbConnect</a></span>(odbc<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/odbc/topics/odbc">odbc</a></span>(), <span class="dt">.connection_string =</span> my_con)

train_query &lt;-<span class="st"> "SELECT </span>
<span class="st">                 [FacilityAccountID]</span>
<span class="st">                ,[AdmitAgeNBR]</span>
<span class="st">                ,[GenderCD]</span>
<span class="st">                ,[EthnicGroupDSC]</span>
<span class="st">                ,[MaritalStatusDSC]</span>
<span class="st">                ,[Readmit30FLG]</span>
<span class="st">  FROM [SAM].[Schema].[SummaryVisitBASE]</span>
<span class="st">  WHERE InpatientFLG = 'F'"</span>

d &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/db_read.html">db_read</a></span>(con, train_query)

models &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/machine_learn.html">machine_learn</a></span>(<span class="dt">d =</span> d, 
                        FacilityAccountID,
                        <span class="dt">models =</span> <span class="st">"rf"</span>,
                        <span class="dt">outcome =</span> Readmit30FLG)

<span class="co"># Save my model</span>
healthcareai<span class="op">::</span><span class="kw"><a href="https://docs.healthcare.ai/reference/save_models.html">save_models</a></span>(models, <span class="st">"readmit_models.RDS"</span>)</code></pre></div>
</div>
<div id="pushing-predictions-to-a-database" class="section level1">
<h1 class="hasAnchor">
<a href="#pushing-predictions-to-a-database" class="anchor"></a>Pushing predictions to a database</h1>
<p>While the frequency will vary depending on the use case, for most healthcare ML scenarios you’ll need predictions on a reoccurring basis. Daily batch predictions are common. To create predictions, new rows (representing patients or patient encounters) are run against the model that lives in the RDA file.</p>
<p>Instead of simply creating predictions in R, however, in a production scenario you’ll be pushing these predictions to a database. Typically we append to the same table each night, such that a person will get an updated risk score for each day they’re in the hospital (for example).</p>
<div id="creating-predictions" class="section level2">
<h2 class="hasAnchor">
<a href="#creating-predictions" class="anchor"></a>Creating predictions</h2>
<p>Now we focus on the code that will run each night to create predictions. Note a couple of things:</p>
<ul>
<li>The query is different from the development step</li>
<li>Here you’re only querying patients that need a prediction (notice <code>WHERE</code> clause)</li>
<li>Here you won’t have the label (i.e., outcome) column in your query</li>
<li>We read the model from disk; if needed, a web service could be involved</li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">prod_query &lt;-<span class="st"> "SELECT </span>
<span class="st">                 [FacilityAccountID]</span>
<span class="st">                ,[AdmitAgeNBR]</span>
<span class="st">                ,[GenderCD]</span>
<span class="st">                ,[EthnicGroupDSC]</span>
<span class="st">                ,[MaritalStatusDSC]</span>
<span class="st">  FROM [SAM].[Schema].[SummaryVisitBASE]</span>
<span class="st">  WHERE InpatientFLG = 'T'"</span>

d_out &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/db_read.html">db_read</a></span>(con, prod_query)

models &lt;-<span class="st"> </span>healthcareai<span class="op">::</span><span class="kw"><a href="https://docs.healthcare.ai/reference/save_models.html">load_models</a></span>(<span class="st">"readmit_models.RDS"</span>)

predictions &lt;-<span class="st"> </span><span class="kw">predict</span>(models, d_out)</code></pre></div>
</div>
<div id="create-the-output-table" class="section level2">
<h2 class="hasAnchor">
<a href="#create-the-output-table" class="anchor"></a>Create the output table</h2>
<p>Before we worry about pushing rows to the database, look at the format of your output by typing <code>glimpse(predictions)</code></p>
<p>You might want push fewer columns than that to a table each night. Here’s how you slim this down:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">predictions &lt;-<span class="st"> </span>predictions <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(FacilityAccountID, predicted_Readmit30FLG) <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># Grab just two columns</span>
<span class="st">  </span><span class="kw">rename</span>(<span class="dt">PredictedProbabilityNBR =</span> predicted_Readmit30FLG) <span class="co"># Change col name</span></code></pre></div>
<p>Now that we have only the columns necessary, let’s shift to the database table.</p>
<div id="outside-of-a-health-catalyst-environment" class="section level3">
<h3 class="hasAnchor">
<a href="#outside-of-a-health-catalyst-environment" class="anchor"></a>Outside of a Health Catalyst environment</h3>
<p>Use a tool like SQL Server Management Studio and a <code>CREATE TABLE</code> statement.</p>
</div>
<div id="inside-a-health-catalyst-environment" class="section level3">
<h3 class="hasAnchor">
<a href="#inside-a-health-catalyst-environment" class="anchor"></a>Inside a Health Catalyst environment</h3>
<ol style="list-style-type: decimal">
<li>Append a few utility columns to your output, so that it matches the typical structure of tables generated by Subject Area Mart Designer (SAMD):</li>
</ol>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">predictions &lt;-<span class="st"> </span>predictions <span class="op">%&gt;%</span>
<span class="st">  </span>add_SAM_utility_cols</code></pre></div>
<ol start="2" style="list-style-type: decimal">
<li>Use SAMD to create the table (since this creates metadata)</li>
</ol>
<ul>
<li>This binding requires a query that not only has the column structure, but also <code>WHERE 0 = 1</code>, such that only R is populating the output table.</li>
</ul>
<p><code>sql      SELECT        '' AS FacilityAccountID      ,'' AS PredictedProbNBR      FROM SAM.Schema.SummaryVisitBASE where 1=0</code> - Edit the column types, name the binding something like ReadmitMLOutputTable, and ensure that’s it generated as expected. - Set the binding to <code>Incremental</code>, such that the table isn’t dropped and reloaded each night.</p>
</div>
</div>
<div id="writing-predictions-to-the-table" class="section level2">
<h2 class="hasAnchor">
<a href="#writing-predictions-to-the-table" class="anchor"></a>Writing predictions to the table</h2>
<p>Here we use the <code>RODBC</code> package, which can be installed via <code>install.packages('RODBC')</code>. Note that the database isn’t specified here, since it was defined above.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(RODBC)

con &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/RODBC/topics/odbcConnect">odbcDriverConnect</a></span>(<span class="dt">connection =</span> my_con)

<span class="kw"><a href="http://www.rdocumentation.org/packages/RODBC/topics/sqlSave">sqlSave</a></span>(con, 
        predictions, 
        <span class="st">"Schema.ReadmitMLOutputTable"</span>, 
        <span class="dt">append =</span> <span class="ot">TRUE</span>, 
        <span class="dt">rownames =</span> <span class="ot">FALSE</span>)

<span class="kw"><a href="http://www.rdocumentation.org/packages/RODBC/topics/odbcClose">odbcClose</a></span>(con)</code></pre></div>
<p>If your predictions arrive in the database, congrats! You’re now ready to work with the DBA/ETL* team to schedule this reoccurring job, such that it runs in a manner that’s dependency-aware.</p>
</div>
</div>
<div id="testing-in-production" class="section level1">
<h1 class="hasAnchor">
<a href="#testing-in-production" class="anchor"></a>Testing in production</h1>
<p>Before users start consuming your awesome ML work, it’s imperative that you verify that the model’s accuracy holds up in production. Performance on retrospective data isn’t the same as performance on incoming production data. Sometimes issues like <a href="https://healthcare.ai/data-leakage-in-healthcare-machine-learning">data leakage</a> or other issues cause the performance to drop.</p>
<p>Effectively, if you’re creating CLABSI predictions, you should wait a few weeks until a large number of the patients who have received risk predictions have left the hospital and had an outcome (CLABSI = Y/N) recorded so you can compare predictions to actual outcomes. Similarly, if you’re predicting 30-day readmissions, you need to wait ~45 days until you have enough data to verify if you accurately predicted who did or didn’t return to the hospital. If you have a heavy class imbalance (with rare CLABSIs, etc), you’ll need to wait longer. This evaluation can be done <a href="https://docs.healthcare.ai/reference/evaluate_classification.html">via healthcare.ai</a>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../../reference/evaluate_classification.html">evaluate_classification</a></span>(predicted, actual)</code></pre></div>
</div>
<div id="full-and-simplest-example-code" class="section level1">
<h1 class="hasAnchor">
<a href="#full-and-simplest-example-code" class="anchor"></a>Full and simplest example code</h1>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(healthcareai)
<span class="kw">library</span>(DBI)
<span class="kw">library</span>(RODBC)
<span class="kw">library</span>(tidyverse)

my_con &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/build_connection_string.html">build_connection_string</a></span>(<span class="dt">server =</span> <span class="st">"HCS-GM0004"</span>,
                                  <span class="dt">database =</span> <span class="st">"SAM"</span>)

con &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/DBI/topics/dbConnect">dbConnect</a></span>(odbc<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/odbc/topics/odbc">odbc</a></span>(), <span class="dt">.connection_string =</span> my_con)

prod_query &lt;-<span class="st"> "SELECT </span>
<span class="st">                 [FacilityAccountID]</span>
<span class="st">                ,[AdmitAgeNBR]</span>
<span class="st">                ,[GenderCD]</span>
<span class="st">                ,[EthnicGroupDSC]</span>
<span class="st">                ,[MaritalStatusDSC]</span>
<span class="st">                ,[Readmit30FLG]</span>
<span class="st">  FROM [SAM].[Schema].[SummaryVisitBASE]</span>
<span class="st">  WHERE InpatientFLG = 'T'"</span>

d_out &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/db_read.html">db_read</a></span>(con, prod_query)

models &lt;-<span class="st"> </span>healthcareai<span class="op">::</span><span class="kw"><a href="https://docs.healthcare.ai/reference/save_models.html">load_models</a></span>(<span class="st">"readmit_models.RDS"</span>)

predictions &lt;-<span class="st"> </span><span class="kw">predict</span>(models, d_out)

con &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/RODBC/topics/odbcConnect">odbcDriverConnect</a></span>(<span class="dt">connection =</span> my_con)

<span class="kw"><a href="http://www.rdocumentation.org/packages/RODBC/topics/sqlSave">sqlSave</a></span>(con, 
        predictions, 
        <span class="st">"Schema.ReadmitMLOutputTableBASE"</span>, 
        <span class="dt">append =</span> <span class="ot">TRUE</span>, 
        <span class="dt">rownames =</span> <span class="ot">FALSE</span>)

<span class="kw"><a href="http://www.rdocumentation.org/packages/RODBC/topics/odbcClose">odbcClose</a></span>(con)</code></pre></div>
<p>*Note: for those working in a Health Catalyst environment, proceed with the ML-Prod document in Spark</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#creating-and-saving-a-model">Creating and saving a model</a></li>
      <li>
<a href="#pushing-predictions-to-a-database">Pushing predictions to a database</a><ul class="nav nav-pills nav-stacked">
<li><a href="#creating-predictions">Creating predictions</a></li>
      <li><a href="#create-the-output-table">Create the output table</a></li>
      <li><a href="#writing-predictions-to-the-table">Writing predictions to the table</a></li>
      </ul>
</li>
      <li><a href="#testing-in-production">Testing in production</a></li>
      <li><a href="#full-and-simplest-example-code">Full and simplest example code</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Levi Thatcher, Michael Levy, Mike Mastanduno, Taylor Larsen, Taylor Miller.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://pkgdown.r-lib.org/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js"></script><script>
  docsearch({
    
    apiKey: 'ac39465bc37cbef616f5de1e646b6037',
    indexName: 'healthcareai',
    inputSelector: 'input#search-input.form-control',
    debug: false // Set debug to true if you want to inspect the dropdown
  });
</script>
</body>
</html>
